<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LoTW WSJT-X Verification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
  <div class="container">
    <div class="jumbotron jumbotron-fluid">
      <div class="container">
        <h1 class="display-4">Foxes of the world</h1>
        <p class="lead">WSJT-X verification system using LoTW certificates for verification</p>
      </div>
    </div>
    <div class="container">
      <h1>Hounds</h1>
      <p>Set your OTP server to in WSJT-X to: <b>https://fotw.xyz/</b></p>
      <p>FoTW will also check 9dx.cc (the default WSJT-X server) as well, so you won't need to change this URL for other
        dxpeditions.</p>
      <img src="hound.png" width="400px" />
      <p></p>
      <hr>
    </div>
    <div class="container">
      <h1>Foxes</h1>
      <p>To provision a FoTW OTP key to use in WSJT-X you need to sign a verification log file generated by us then
        upload it for verification by our servers. A correctly signed verification log will provide a FoTW OTP key
        instantly which can then be used in WSJT-X. No manual approval is required.</p>
      <p><b>Requirements:</b>
      <ul>
        <li>A valid LoTW certificate for the callsign you wish to use</li>
      </ul>
      </p>
      <div class="accordion" id="accordionFoxes">
        <div class="accordion-item">
          <h3 class="accordion-header"><button id="step1" class="accordion-button" type="button"
              data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true"
              aria-controls="collapseOne">Step 1 - Download verification log</button></h3>
          <div id="collapseOne" class="accordion-collapse show collapse" data-bs-parent="#accordionFoxes">
            <div class="accordion-body">
              <div class="mb-3">
                <form onsubmit="return downloadAdif()" action="">
                  <button type="submit" class="btn btn-primary">Click this button to download verification
                    log</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h3 class="accordion-header"><button id="step2" class="accordion-button collapsed" type="button"
              data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true"
              aria-controls="collapseTwo">Step 2 - Sign the verification log with TQSL</button></h3>
          <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFoxes">
            <div class="accordion-body">
              <ol>
                <li>
                  <p>Open TQSL. In the menu click "Sign and save ADIF" (do not select upload; you should not upload this
                    log to the ARRL. Only upload this file to fotw.xyz).</p>
                  <img src="sign.jpg" width="400px" />
                </li>
                <li>
                  <p>Open the ADIF file you just downloaded, select a place to save the resulting tq8 file.</p>
                </li>
                <li>
                  <p>Select the certificate you'd like to use for WSJT-X verification.</p>
                </li>
                <li>
                  <p>Verify the details. Leave date range blank.</p><img src="date.png" width="400px">
                </li>
                <li>
                  <p></p>
                  <form onsubmit="return uploadAdif(this.tq)" action="" class="row g-3">
                    <label for="tq" class="form-label col-auto col-form-label">Upload TQ8 File to FoTW</label>
                    <div class="col-auto">

                      <input class="form-control" type="file" id="tq" name="tq8" accept=".tq8" />
                    </div>
                    <div class="col-auto">
                      <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                  </form>
                  <p>
                  <div class="alert alert-warning" role="alert"> Do not share this tq8 file with any other site or
                    person.
                  </div>
                  <div class="alert alert-success" role="alert" id="uploadsuccess" style="display:none"></div>
                  <div class="alert alert-danger" role="alert" id="uploadfailure" style="display:none"></div>
                </p>
                </li>
              </ol>

            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h3 class="accordion-header"><button id="step3" class="accordion-button collapsed" type="button"
              data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="true"
              aria-controls="collapseThree">Step 3 - Configure WSJT-X</button></h3>
          <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionFoxes">
            <div class="accordion-body">
              <p>Open WSJT-X settings. Under advanced select "Special operating activities", tick OTP and enter your
                key
                from
                the following details.</p>

              <form>
                <div class="form-group">
                  <label for="otpCallsign">Callsign:</label>
                  <input type="text" class="form-control" id="otpCallsign" placeholder="N0CALL" disabled>
                </div>
                <div class="form-group">
                  <label for="otpKey">OTP Key:</label>
                  <input type="text" class="form-control" id="otpKey" placeholder="Perform Step 2 first" disabled>
                </div>
              </form>
              <p></p>
              <p><b>Example:</b></p>

              <img src="key.png" width="400px">

              <p></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr>
    <div class="container">
      <h1>How it works</h1>
      <a href="https://github.com/xssfox/fotw">Source code</a>
      <h2>LoTW</h2>
      <p>LoTW uses x509 certificates to sign QSOs. Each QSO is signed using a callsign certificate. To obtain a callsign
        certificate an operator is required to go through a verification process outlined by the ARRL. FoTW uses the
        TQSL software to validate that an operator has been verified through this system.</p>
      <p><b>FoTW verification process:</b>
      <ol>
        <li>Generate a log file for the user to verify</li>
        <li>The user signs the log file then uploads to us</li>
        <li>A lambda function extracts the log, obtaining the certificate and signed data</li>
        <li>It then validates that the log is correct, the signature is matches the log, and that the certificate used
          to sign the log has been signed by the LoTW</li>
        <li>The callsign is extract from the certificate, then hashed with a secret. This forms part of the TOTP secret
        </li>
        <li>The OTP secret is sent back to the users browser along with the callsign</li>
      </ol>
      </p>
      <h2>ToTP Server</h2>
      <p>
        The ToTP server is hosted on AWS using CloudFront, API Gateway and Lambda. Effectively the Lambda function is
        waiting for requests to <code>https://fotw.xyz/check/{callsign}/{timestamp}/{code}</code>
      </p>
      <p><b>ToTP process:</b>
      <ol>
        <li>Callsign is converted to uppercase</li>
        <li>Timestamp is parsed to unix epoch seconds, then divided by 30</li>
        <li>".text" is removed from the code</li>
        <li>The timestamp is checked to ensure its not in the future</li>
        <li>OTP secret is calculated by hashing a secret with the provided callsign</li>
        <li>A token is calculated using standard HOTP with the timestamp (remember divided by 30)</li>
        <li>We compare the provided code and the generated HOTP code - if they match we return back
          <code> VERIFIED</code> (with no additional bytes on the end such as a new line)</li>
        <li>If it doesn't match we check 9dx.cc - if they respond we send back their response if no we send back
          <code> UNVERIFIED</code></li>
      </ol>
      </p>
      <h2>Limitations</h2>
      <p>
      <ul>
        <li>This system requires the user to keep the signed TQ8 file secret / not be tricked into signing a file for
          someone else. Otherwise a user with access to a signed verification log TQ8 file can request an OTP. Usually
          sharing TQ8 files wouldn't be a security issue - so this goes against norms a bit.</li>
        <li>There's no self service facility to rotate an OTP key if it was stolen or compromised. This is because there
          is currently no database in this system. There is facility to do this however it has to be done by hand at
          this stage. <a href="https://michaela.lgbt">Contact me</a> if this happens.</li>
        <li>This is as secure as LoTW. Which is <a
            href="https://www.arrl.org/news/arrl-it-security-incident-report-to-members">not very secure</a>. However
          WSJT-X verification is a low stakes game - so collectively I think we can accept the risk.</li>
        <li>Obviously this requires LoTW to verify users</li>
      </ul>
      </p>
    </div>
    <div class="container">
      <hr>
      <footer>
        <p>Created and maintained by <a href="https://michaela.lgbt">Michaela - VK3FUR</a></p>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="js.js" crossorigin="anonymous"></script>
</body>

</html>